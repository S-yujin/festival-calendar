<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="|${festival.fcltyNm} - 축제 상세정보|">
        축제 상세정보
    </title>

    <!-- 공통 헤더/레이아웃 스타일 -->
    <link rel="stylesheet" th:href="@{/css/header.css}">
    <link rel="stylesheet" th:href="@{/css/festivals-home.css}">
    <!-- 상세페이지 전용 스타일 (hero, info-table, 지도 등) -->
    <link rel="stylesheet" th:href="@{/css/detail.css}">
</head>
<body>

<!-- 공통 헤더 프래그먼트 -->
<div th:replace="~{fragments/header :: siteHeader}"></div>

<main class="detail-layout">

    <!-- ===== 상단 히어로 영역 ===== -->
    <section class="festival-hero">
        <!-- 왼쪽: 텍스트 정보 -->
        <div class="hero-info">
            <p class="hero-badge">축제 상세정보</p>

            <h1 class="hero-title" th:text="${festival.fcltyNm}">
                부산국제아동도서전
            </h1>

            <div class="hero-meta">
                <div>
                    <span class="meta-label">기간</span>
                    <span class="meta-value"
                          th:text="${#temporals.format(festival.fstvlStart, 'yyyy.MM.dd')} + ' ~ ' +
                                   ${#temporals.format(festival.fstvlEnd, 'yyyy.MM.dd')}">
                        2025.12.11 ~ 2025.12.14
                    </span>
                </div>

                <div>
                    <span class="meta-label">장소</span>
                    <span class="meta-value"
                          th:text="${festival.master != null ? (festival.master.ctprvnNm + ' ' + festival.master.signguNm) : ''}">
                        부산 해운대구
                    </span>
                </div>

                <div th:if="${festival.master != null and festival.master.telNo != null}">
                    <span class="meta-label">문의</span>
                    <span class="meta-value" th:text="${festival.master.telNo}">
                        051-000-0000
                    </span>
                </div>

                <div th:if="${festival.master != null and festival.master.hmpgAddr != null}">
                    <span class="meta-label">홈페이지</span>
                    <a class="meta-link"
                       th:href="${festival.master.hmpgAddr}"
                       target="_blank"
                       th:text="${festival.master.hmpgAddr}">
                        홈페이지 바로가기
                    </a>
                </div>
            </div>

            <!-- 예상 방문 소요 시간 같은 부가 정보가 있을 때만 표시 -->
            <p class="hero-expected"
               th:if="${expectedPeriod != null}"
               th:text="|예상 방문 소요 시간: ${expectedPeriod}|">
                예상 방문 소요 시간: 반나절
            </p>
        </div>

        <!-- 오른쪽: 대표 이미지 -->
        <div class="hero-image">
            <img th:if="${festival.master != null and festival.master.firstImageUrl != null}"
                 th:src="${festival.master.firstImageUrl}"
                 alt="축제 대표 이미지">
            <div th:if="${festival.master == null or festival.master.firstImageUrl == null}" 
                 class="hero-image-placeholder">
                대표 이미지가 없습니다.
            </div>
        </div>
    </section>

    <!-- ===== 축제 소개 섹션 ===== -->
    <section class="detail-section">
        <h2>축제 소개</h2>

        <!-- overview가 있으면 overview 사용 -->
        <p class="detail-overview" 
           th:if="${festival.master != null and festival.master.overview != null}"
           th:text="${festival.master.overview}">
            축제에 대한 소개 문구가 들어갑니다.
        </p>

        <!-- overview가 없으면 안내 문구 -->
        <p class="detail-overview"
           th:if="${festival.master == null or festival.master.overview == null}">
            현재 제공되는 상세 소개 문구가 없습니다.
        </p>
    </section>

    <!-- ===== 기본 정보 테이블 ===== -->
    <section class="detail-section">
        <h2>기본 정보</h2>

        <table class="info-table">
            <tr>
                <th>개최 기간</th>
                <td th:text="${#temporals.format(festival.fstvlStart, 'yyyy.MM.dd')} + ' ~ ' +
                             ${#temporals.format(festival.fstvlEnd, 'yyyy.MM.dd')}">
                    2025.12.11 ~ 2025.12.14
                </td>
            </tr>
            <tr>
                <th>개최 장소</th>
                <td th:text="${festival.master != null ? festival.master.addr1 : ''}">
                    부산 해운대구 벡스코 일원
                </td>
            </tr>
            <tr th:if="${festival.originNm != null}">
                <th>주최 / 주관</th>
                <td th:text="${festival.originNm}">
                    주최/주관 정보
                </td>
            </tr>
        </table>
    </section>

    <!-- ===== 위치 정보 & 지도 ===== -->
    <section class="detail-section">
        <h2>위치 정보</h2>

        <p class="detail-address" th:text="${festival.master != null ? festival.master.addr1 : ''}">
            주소 텍스트
        </p>

        <div id="festivalDetailMap" class="detail-map"></div>
    </section>

    <!-- ===== 축제 리뷰 ===== -->
    <section class="detail-section review-section">
        <div class="section-header">
            <h2 class="section-title">축제 리뷰</h2>
        </div>

        <!-- 리뷰가 하나도 없을 때 -->
        <div th:if="${#lists.isEmpty(reviews)}" class="review-empty">
            아직 등록된 리뷰가 없습니다. 첫 리뷰를 남겨보세요!
        </div>

        <!-- 리뷰 목록 -->
        <ul th:if="${!#lists.isEmpty(reviews)}" class="review-list">
            <li th:each="review : ${reviews}" class="review-item">
                <div class="review-header">
                    <div class="review-meta">
                        <span class="review-nickname"
                              th:text="${review.nickname}">닉네임</span>
                        <span class="review-date"
                              th:text="${#temporals.format(review.createdAt, 'yyyy.MM.dd')}">
                            2025.12.11
                        </span>
                    </div>
                    <div class="review-rating">
                        <span class="star">★</span>
                        <span th:text="${review.rating}">5</span>
                        <span class="rating-unit"> / 5</span>
                    </div>
                </div>

                <p class="review-content" th:text="${review.content}">
                    리뷰 내용입니다.
                </p>

                <div class="review-footer">
                    <!-- ✅ attachmentId 체크 부분 제거 (파일 기능은 나중에 구현) -->

                    <!-- 본인 리뷰일 때만 수정/삭제 버튼 -->
                    <div class="review-actions"
                         th:if="${member != null and review.memberId != null and member.id.equals(review.memberId)}">
                        <button type="button"
                                class="btn-text edit-review-btn"
                                th:data-id="${review.id}"
                                th:data-content="${review.content}"
                                th:data-rating="${review.rating}">
                            수정
                        </button>
                        <button type="button"
                                class="btn-text delete-review-btn"
                                th:data-id="${review.id}">
                            삭제
                        </button>
                    </div>
                </div>
            </li>
        </ul>

        <!-- 리뷰 작성 폼 (로그인한 사용자만) -->
        <div th:if="${member != null}" class="review-form-wrapper">
            <h3 class="review-form-title">리뷰 작성하기</h3>
            
            <form id="reviewForm" enctype="multipart/form-data" class="review-form">
                <!-- 별점 -->
                <div class="form-group">
                    <label class="form-label">
                        별점 <span class="required">*</span>
                    </label>
                    <div class="rating-input">
                        <span class="star-btn" data-rating="1">★</span>
                        <span class="star-btn" data-rating="2">★</span>
                        <span class="star-btn" data-rating="3">★</span>
                        <span class="star-btn" data-rating="4">★</span>
                        <span class="star-btn" data-rating="5">★</span>
                    </div>
                    <input type="hidden" id="ratingValue" name="rating" value="5" required>
                </div>

                <!-- 리뷰 내용 -->
                <div class="form-group">
                    <label for="reviewContent" class="form-label">
                        리뷰 내용 <span class="required">*</span>
                    </label>
                    <textarea 
                        id="reviewContent" 
                        name="content" 
                        rows="4" 
                        placeholder="축제에 대한 솔직한 후기를 남겨주세요."
                        required
                        class="form-textarea"></textarea>
                </div>

                <!-- 제출 버튼 -->
                <div class="form-actions">
                    <button 
                        type="button" 
                        onclick="document.getElementById('reviewForm').reset(); updateStarRating(5);"
                        class="btn-cancel">
                        취소
                    </button>
                    <button 
                        type="submit"
                        class="btn-submit">
                        리뷰 등록
                    </button>
                </div>
            </form>
        </div>

        <!-- 로그인 안내 -->
        <div class="review-login-hint" th:if="${member == null}">
            리뷰를 남기려면 먼저
            <a th:href="@{/auth/login}" class="link-inline">로그인</a>
            해주세요.
        </div>
    </section>

    <!-- ===== 뒤로가기 / 목록 버튼 ===== -->
    <section class="detail-section">
        <a th:href="@{/festivals/list}" class="back-link">목록으로 돌아가기</a>
    </section>

</main>

<!-- ✅ 네이버 지도 API 스크립트 -->
<script type="text/javascript"
        src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=imrp8lidfv">
</script>

<!-- 상세 페이지 지도 스크립트 -->
<script th:inline="javascript">
/*<![CDATA[*/
    // 위도/경도 (FestivalMaster의 mapX, mapY 사용)
    var lat = /*[[${festival.master != null ? festival.master.mapY : null}]]*/ null;
    var lng = /*[[${festival.master != null ? festival.master.mapX : null}]]*/ null;

    // 좌표가 없으면 기본값으로 부산 시청 근처 사용
    if (lat == null || lng == null) {
        lat = 35.1796;
        lng = 129.0756;
    }

    var map = new naver.maps.Map('festivalDetailMap', {
        center: new naver.maps.LatLng(lat, lng),
        zoom: 14
    });

    var marker = new naver.maps.Marker({
        position: new naver.maps.LatLng(lat, lng),
        map: map
    });
/*]]>*/
</script>

<!-- 리뷰 별점 및 폼 제출 스크립트 -->
<script th:inline="javascript">
/*<![CDATA[*/
    // 별점 클릭 이벤트
    document.querySelectorAll('.star-btn').forEach(star => {
        star.addEventListener('click', function() {
            const rating = parseInt(this.dataset.rating);
            updateStarRating(rating);
        });
    });

    // 별점 업데이트 함수
    function updateStarRating(rating) {
        document.getElementById('ratingValue').value = rating;
        document.querySelectorAll('.star-btn').forEach((star, index) => {
            if (index < rating) {
                star.style.color = '#fbbf24'; // 노란색
            } else {
                star.style.color = '#d1d5db'; // 회색
            }
        });
    }

    // 초기 별점 5점으로 설정
    updateStarRating(5);

    // 리뷰 폼 제출
    document.getElementById('reviewForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const eventId = /*[[${festival.id}]]*/ 0;
        const rating = document.getElementById('ratingValue').value;
        const content = document.getElementById('reviewContent').value;

        if (!content.trim()) {
            alert('리뷰 내용을 입력해주세요.');
            return;
        }

        const formData = new FormData();
        formData.append('rating', rating);
        formData.append('content', content);
        
        // 파일 기능은 나중에 추가
        // const fileInput = document.getElementById('reviewFile');
        // if (fileInput && fileInput.files.length > 0) {
        //     formData.append('file', fileInput.files[0]);
        // }

        try {
            const response = await fetch(`/api/reviews/event/${eventId}`, {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                alert('리뷰가 등록되었습니다.');
                location.reload(); // 페이지 새로고침
            } else {
                const error = await response.text();
                alert('리뷰 등록 실패: ' + error);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('리뷰 등록 중 오류가 발생했습니다.');
        }
    });

    // 리뷰 수정 버튼 이벤트
    document.querySelectorAll('.edit-review-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const reviewId = this.dataset.id;
            const content = this.dataset.content;
            const rating = parseInt(this.dataset.rating);

            // 수정 모달 또는 폼 영역 생성
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            `;

            modal.innerHTML = `
                <div style="background: white; padding: 32px; border-radius: 12px; max-width: 500px; width: 90%;">
                    <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 24px;">리뷰 수정</h3>
                    
                    <form id="editReviewForm" style="display: flex; flex-direction: column; gap: 16px;">
                        <div>
                            <label style="display: block; font-size: 14px; font-weight: 500; margin-bottom: 8px;">
                                별점 <span style="color: #ef4444;">*</span>
                            </label>
                            <div class="edit-rating-input" style="display: flex; gap: 8px; font-size: 24px;">
                                <span class="edit-star-btn" data-rating="1" style="cursor: pointer; color: #d1d5db;">★</span>
                                <span class="edit-star-btn" data-rating="2" style="cursor: pointer; color: #d1d5db;">★</span>
                                <span class="edit-star-btn" data-rating="3" style="cursor: pointer; color: #d1d5db;">★</span>
                                <span class="edit-star-btn" data-rating="4" style="cursor: pointer; color: #d1d5db;">★</span>
                                <span class="edit-star-btn" data-rating="5" style="cursor: pointer; color: #d1d5db;">★</span>
                            </div>
                            <input type="hidden" id="editRatingValue" value="${rating}">
                        </div>

                        <div>
                            <label for="editContent" style="display: block; font-size: 14px; font-weight: 500; margin-bottom: 8px;">
                                리뷰 내용 <span style="color: #ef4444;">*</span>
                            </label>
                            <textarea 
                                id="editContent" 
                                rows="4" 
                                required
                                style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; resize: vertical;">${content}</textarea>
                        </div>

                        <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 8px;">
                            <button 
                                type="button" 
                                class="cancel-edit-btn"
                                style="padding: 10px 20px; background: #fff; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; cursor: pointer;">
                                취소
                            </button>
                            <button 
                                type="submit"
                                style="padding: 10px 20px; background: #6366f1; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer;">
                                수정 완료
                            </button>
                        </div>
                    </form>
                </div>
            `;

            document.body.appendChild(modal);

            // 별점 초기화
            function updateEditStarRating(rating) {
                document.getElementById('editRatingValue').value = rating;
                document.querySelectorAll('.edit-star-btn').forEach((star, index) => {
                    if (index < rating) {
                        star.style.color = '#fbbf24';
                    } else {
                        star.style.color = '#d1d5db';
                    }
                });
            }
            updateEditStarRating(rating);

            // 별점 클릭 이벤트
            document.querySelectorAll('.edit-star-btn').forEach(star => {
                star.addEventListener('click', function() {
                    const r = parseInt(this.dataset.rating);
                    updateEditStarRating(r);
                });
            });

            // 취소 버튼
            modal.querySelector('.cancel-edit-btn').addEventListener('click', () => {
                document.body.removeChild(modal);
            });

            // 모달 배경 클릭 시 닫기
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });

            // 수정 폼 제출
            document.getElementById('editReviewForm').addEventListener('submit', async function(e) {
                e.preventDefault();

                const newContent = document.getElementById('editContent').value;
                const newRating = document.getElementById('editRatingValue').value;

                if (!newContent.trim()) {
                    alert('리뷰 내용을 입력해주세요.');
                    return;
                }

                try {
                    const response = await fetch(`/api/reviews/${reviewId}`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            content: newContent,
                            rating: parseInt(newRating)
                        })
                    });

                    if (response.ok) {
                        alert('리뷰가 수정되었습니다.');
                        location.reload();
                    } else {
                        const error = await response.text();
                        alert('리뷰 수정 실패: ' + error);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('리뷰 수정 중 오류가 발생했습니다.');
                }
            });
        });
    });

    // 리뷰 삭제 버튼 이벤트
    document.querySelectorAll('.delete-review-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
            if (!confirm('정말 이 리뷰를 삭제하시겠습니까?')) {
                return;
            }

            const reviewId = this.dataset.id;

            try {
                const response = await fetch(`/api/reviews/${reviewId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('리뷰가 삭제되었습니다.');
                    location.reload();
                } else {
                    const error = await response.text();
                    alert('리뷰 삭제 실패: ' + error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('리뷰 삭제 중 오류가 발생했습니다.');
            }
        });
    });
/*]]>*/
</script>

</body>
</html>