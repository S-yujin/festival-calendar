<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title th:text="${year} + '년 ' + ${month} + '월 축제 캘린더'">
        축제 캘린더
    </title>

    <!-- 공통/페이지 CSS (원하는 파일명으로 만들어서 연결하면 됨) -->
    <link rel="stylesheet" th:href="@{/css/base.css}">
	<link rel="stylesheet" th:href="@{/css/header.css}">
    <link rel="stylesheet" th:href="@{/css/calendar.css}">
</head>
<body>

<!-- 공통 헤더 -->
<div th:replace="~{fragments/header :: header}"></div>

<main class="calendar-layout">

    <!-- 상단 설명 + 월 이동 영역 -->
    <section class="calendar-top">
        <div class="calendar-title">
            <h1 th:text="${year} + '년 ' + ${month} + '월 축제 캘린더'">
                2025년 1월 축제 캘린더
            </h1>
            <p class="calendar-desc">
                한눈에 보는 월별 축제 일정입니다. 날짜별로 열리는 축제를 확인해 보세요.<br>
                아래 캘린더에서 날짜를 확인하고, 아래 리스트에서 상세 정보를 확인할 수 있습니다.
            </p>
        </div>

        <div class="calendar-controls">
            <!-- 이전/다음 달 이동 -->
            <div class="calendar-nav">
                <a class="cal-nav-btn"
                   th:href="@{/festivals/calendar(year=${year}, month=${month-1})}">‹ 이전 달</a>
                <span class="cal-current"
                      th:text="${year} + '.' + ${month}">2025.1</span>
                <a class="cal-nav-btn"
                   th:href="@{/festivals/calendar(year=${year}, month=${month+1})}">다음 달 ›</a>
            </div>

            <!-- 연/월 직접 선택 -->
            <form th:action="@{/festivals/calendar}" method="get" class="cal-form">
                <label>
                    연도
                    <input type="number" name="year" th:value="${year}" style="width:80px;">
                </label>
                <label>
                    월
                    <input type="number" name="month" min="1" max="12"
                           th:value="${month}" style="width:60px;">
                </label>
                <button type="submit">이동</button>
            </form>
        </div>
    </section>

    <!-- 캘린더 그리드 -->
    <section class="calendar-section">
        <table class="calendar-table">
            <thead>
            <tr>
                <th>일</th>
                <th>월</th>
                <th>화</th>
                <th>수</th>
                <th>목</th>
                <th>금</th>
                <th>토</th>
            </tr>
            </thead>
			<div class="calendar-body"
			     th:with="start=${calendarStart},
			              end=${calendarEnd},
			              lastDay=${end.dayOfMonth},
			              firstDow=${(#temporals.dayOfWeek(start) % 7) + 1}">

            <!-- 6주(최대) 고정 루프 -->
            <tr th:each="week : ${#numbers.sequence(0,5)}">
                <td th:each="dow : ${#numbers.sequence(1,7)}"
                    th:with="
                        day=${week * 7 + dow - firstDow + 1},
                        valid=${day >= 1 and day <= lastDay},
                        dayDate=${valid ? start.withDayOfMonth(day) : null},
                        dayFestivals=${valid ? festivalMap[dayDate] : null}
                    ">
                    <!-- 유효한 날짜만 표시 -->
                    <div th:if="${valid}" class="cal-cell">
                        <div class="cal-day-num" th:text="${day}">1</div>

                        <!-- 해당 날짜 축제 (최대 2개 보여주고, 나머지는 '외 n개') -->
                        <ul class="cal-day-festivals"
                            th:if="${dayFestivals != null}"
                            th:with="cnt=${#lists.size(dayFestivals)}">
                            <li th:each="f, st : ${dayFestivals}"
                                th:if="${st.index} &lt; 2">
                                <a th:href="@{|/festivals/${f.id}|}"
                                   th:text="${f.fcltyNm}">축제명</a>
                            </li>
                            <li class="cal-more" th:if="${cnt > 2}">
                                외 <span th:text="${cnt - 2}">0</span>개
                            </li>
                        </ul>
                    </div>
                </td>
            </tr>

            </tbody>
        </table>
    </section>

    <!-- 아래: 이 달의 축제 리스트 (날짜별로 묶어서) -->
    <section class="calendar-list-section"
             th:if="${festivalMap != null and !festivalMap.isEmpty()}">
        <h2>이달의 축제 목록</h2>
        <p class="calendar-list-desc">
            날짜별로 열리는 축제를 한 번에 볼 수 있어요. 축제 이름을 클릭하면 상세 페이지로 이동합니다.
        </p>

        <ul class="calendar-day-list">
            <!-- Map<LocalDate, List<Festivals>> 를 그대로 돌릴 수 있음: entry.key / entry.value -->
            <li class="calendar-day-item" th:each="entry : ${festivalMap}">
                <div class="calendar-list-date"
                     th:text="${#temporals.format(entry.key, 'MM.dd (E)')}">
                    01.01 (수)
                </div>
                <ul class="calendar-list-items">
                    <li th:each="f : ${entry.value}">
                        <a th:href="@{|/festivals/${f.id}|}"
                           th:text="${f.fcltyNm}">축제명</a>
                    </li>
                </ul>
            </li>
        </ul>
    </section>

    <!-- 이 달에 진짜 아무 것도 없을 때 -->
    <section class="calendar-empty"
             th:if="${festivalMap == null or festivalMap.isEmpty()}">
        <p>이 달에는 등록된 축제가 없습니다.</p>
    </section>

    <div class="calendar-back-link">
        <a th:href="@{/festivals}">« 메인으로 돌아가기</a>
    </div>

</main>

</body>
</html>
