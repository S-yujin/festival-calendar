<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>축제 목록 - 축제 한눈에 보기</title>
    <link rel="stylesheet" th:href="@{/css/list.css}">
    <link rel="stylesheet" th:href="@{/css/header.css}">
</head>
<body>

<!-- 공통 헤더 -->
<div th:replace="~{fragments/header :: header}"></div>

<!-- 상단 필터 바 -->
<div class="filter-bar">
    <form th:action="@{/festivals/list}" method="get"
          style="display:flex; gap:8px; width:100%; align-items:center;">

        <!-- 지역 -->
        <div>
            <label for="region" style="font-size:13px; color:#555;">지역</label>
            <select id="region" name="region" class="filter-btn">
                <option value="">전체</option>
                <option th:each="r : ${regions}"
                        th:value="${r}"
                        th:text="${r}"
                        th:selected="${r} == ${region}">
                </option>
            </select>
        </div>

        <!-- 기간 -->
        <div>
            <label for="startDate" style="font-size:13px; color:#555;">기간</label>
            <input type="date" id="startDate" name="startDate"
                   th:value="${startDate}" class="filter-btn">
            ~
            <input type="date" id="endDate" name="endDate"
                   th:value="${endDate}" class="filter-btn">
        </div>

        <!-- 유형 -->
        <div>
            <label for="category" style="font-size:13px; color:#555;">유형</label>
            <select id="category" name="category" class="filter-btn">
                <option value="">전체</option>
                <option value="음악" th:selected="${category}=='음악'">음악/공연</option>
                <option value="먹거리" th:selected="${category}=='먹거리'">먹거리/야시장</option>
                <option value="문화" th:selected="${category}=='문화'">문화/전통</option>
                <option value="꽃" th:selected="${category}=='꽃'">꽃/자연</option>
            </select>
        </div>

        <!-- 혼잡도 -->
        <div>
            <label for="congestion" style="font-size:13px; color:#555;">혼잡도</label>
            <select id="congestion" name="congestion" class="filter-btn">
                <option value="">전체</option>
                <option value="여유" th:selected="${congestion}=='여유'">여유</option>
                <option value="보통" th:selected="${congestion}=='보통'">보통</option>
                <option value="혼잡" th:selected="${congestion}=='혼잡'">혼잡 예상</option>
            </select>
        </div>

        <!-- 키워드 (컨트롤러에서 q 처리할 때만 의미 있음) -->
        <div style="flex:1;">
            <label for="keyword" style="font-size:13px; color:#555;">키워드</label>
            <input type="text" id="keyword" name="q"
                   th:value="${keyword}" class="filter-btn" style="width:100%;">
        </div>

        <!-- 검색/초기화 -->
        <div class="filter-right">
            <button type="submit" class="filter-btn"
                    style="background:#6c2bd9; color:#fff; border-color:#6c2bd9;">
                검색하기
            </button>
            <a th:href="@{/festivals/list}" class="sort-link">조건 초기화</a>
        </div>
    </form>
</div>

<!-- 2컬럼 레이아웃: 왼쪽 리스트, 오른쪽 지도 -->
<div class="page-2col">

    <!-- 왼쪽: 리스트 패널 -->
    <main class="list-panel">
        <section>
            <h1 th:text="|${year}년 전국 축제 한눈에 보기|">
                2025년 전국 축제 한눈에 보기
            </h1>
            <p style="font-size:14px; color:#555; margin-top:4px;">
                지역·날짜·유형·혼잡도 조건을 선택해서 원하는 축제를 빠르게 찾아보세요.
            </p>
        </section>

        <!-- 결과 없을 때 -->
        <p th:if="${#lists.isEmpty(festivals)}" style="margin-top:16px;">
            조건에 맞는 축제가 없습니다.
        </p>

        <!-- 카드 리스트 -->
        <section th:if="${!#lists.isEmpty(festivals)}" style="margin-top:16px;">
            <div class="card-list">
                <article class="festival-card" th:each="f : ${festivals}">
                    <a th:href="@{/festivals/{id}(id=${f.id})}">

                        <!-- 썸네일 -->
                        <div class="card-thumb">
                            <img th:if="${f.firstImageUrl != null}"
                                 th:src="${f.firstImageUrl}"
                                 alt="축제 이미지">
                        </div>

                        <!-- 텍스트 영역 -->
                        <div class="card-body">
                            <span class="status-badge">축제</span>

                            <h3 class="card-title" th:text="${f.fcltyNm}">축제명</h3>

                            <p class="card-period"
                               th:text="${#temporals.format(f.fstvlBeginDe, 'MM.dd')} + ' ~ ' +
                                        ${#temporals.format(f.fstvlEndDe, 'MM.dd')}">
                                00.00 ~ 00.00
                            </p>

                            <p class="card-loc"
                               th:text="${f.ctprvnNm + ' ' + f.signguNm}">
                                지역
                            </p>
                        </div>
                    </a>
                </article>
            </div>
        </section>
    </main>

    <!-- 오른쪽: 지도 패널 -->
	<aside class="map-panel">
	  <div class="map-toolbar">
	    <a class="map-toggle"
	       th:classappend="${mapMode == 'ongoing' ? ' active' : ''}"
	       th:href="@{/festivals/list(region=${region}, startDate=${startDate}, endDate=${endDate}, category=${category}, congestion=${congestion}, mapMode='ongoing')}">
	      진행중만
	    </a>

	    <a class="map-toggle"
	       th:classappend="${mapMode == 'all' ? ' active' : ''}"
	       th:href="@{/festivals/list(region=${region}, startDate=${startDate}, endDate=${endDate}, category=${category}, congestion=${congestion}, mapMode='all')}">
	      전체
	    </a>
	  </div>

	  <p th:if="${#lists.isEmpty(markers)}" class="map-empty">
	    현재 지도에 표시할 축제가 없습니다.
	  </p>

	  <div id="festivalMap"></div>
	</aside>

</div>

<!-- 네이버 지도 API -->
<script type="text/javascript"
        src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=imrp8lidfv"></script>

<!-- 네이버 지도 위에 마커 그리기 -->
<script th:inline="javascript">
/*<![CDATA[*/
  var markers = /*[[${markers}]]*/ [];

  var map = new naver.maps.Map('festivalMap', {
    center: new naver.maps.LatLng(36.5, 127.5),
    zoom: 7
  });

  if (markers.length > 0) {
    var bounds = new naver.maps.LatLngBounds();

    markers.forEach(function (m) {
      var position = new naver.maps.LatLng(m.lat, m.lng);

      // status: "ONGOING" | "UPCOMING" | "PAST"
      var status = (m.status || "PAST");

      var marker = new naver.maps.Marker({
        position: position,
        map: map,

        // ✅ HTML 마커 아이콘 (상태별 class 적용)
        icon: {
          content: '<div class="nm-marker ' + status + '"></div>',
          anchor: new naver.maps.Point(7, 7) // 14x14의 중앙
        },

        // ✅ 진행중이 위로 오게
        zIndex: (status === "ONGOING" ? 200 : status === "UPCOMING" ? 150 : 100)
      });

      var info = new naver.maps.InfoWindow({
        content:
          '<div style="padding:6px 10px; font-size:12px;">' +
            '<a href="/festivals/' + m.id + '" style="text-decoration:none;">' +
              m.name +
            '</a>' +
          '</div>'
      });

      naver.maps.Event.addListener(marker, 'click', function () {
        info.open(map, marker);
      });

      bounds.extend(position);
    });

    map.fitBounds(bounds);
  }
/*]]>*/
</script>
</body>
</html>