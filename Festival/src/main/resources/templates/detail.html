<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="|${festival.fcltyNm} - 축제 상세정보|">축제 상세정보</title>

    <!-- 공통 헤더/레이아웃 스타일 -->
    <link rel="stylesheet" th:href="@{/css/header.css}">
    <link rel="stylesheet" th:href="@{/css/festivals-home.css}">
    <!-- 상세페이지 전용 스타일 -->
    <link rel="stylesheet" th:href="@{/css/detail.css}">
</head>
<body>

<!-- 공통 헤더 프래그먼트 -->
<div th:replace="~{fragments/header :: siteHeader}"></div>

<main class="detail-layout">

    <!-- ===== 상단 히어로 영역 ===== -->
    <section class="festival-hero">
        <div class="hero-info">
            <div class="hero-top">
                <p class="hero-badge">축제 상세정보</p>

                <!-- ✅ 북마크 버튼 -->
                <button id="bookmarkBtn"
                        class="bookmark-btn"
                        th:data-event-id="${festival.id}"
                        th:if="${member != null}"
                        type="button"
                        aria-pressed="false">
                    <!-- ✅ 아이콘을 “사진처럼” 북마크 모양으로 변경 -->
                    <svg class="bookmark-icon" xmlns="http://www.w3.org/2000/svg"
                         width="22" height="22" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2"
                         stroke-linecap="round" stroke-linejoin="round">
                        <!-- 깔끔한 북마크 윤곽 -->
                        <path d="M7 3h10a2 2 0 0 1 2 2v16l-7-4-7 4V5a2 2 0 0 1 2-2z"/>
                    </svg>
                    <span class="bookmark-text">북마크</span>
                </button>
            </div>

            <h1 class="hero-title" th:text="${festival.fcltyNm}">부산국제아동도서전</h1>

            <div class="hero-meta">
                <div>
                    <span class="meta-label">기간</span>
                    <span class="meta-value"
                          th:text="${festival.fstvlStart != null and festival.fstvlEnd != null
                                   ? (#temporals.format(festival.fstvlStart, 'yyyy.MM.dd') + ' ~ ' + #temporals.format(festival.fstvlEnd, 'yyyy.MM.dd'))
                                   : ''}">
                        2025.12.11 ~ 2025.12.14
                    </span>
                </div>

                <div>
                    <span class="meta-label">장소</span>
                    <span class="meta-value"
                          th:text="${festival.master != null
                                  ? ((festival.master.ctprvnNm != null ? festival.master.ctprvnNm : '')
                                     + (festival.master.signguNm != null ? ' ' + festival.master.signguNm : '')).trim()
                                  : ''}">
                        부산 해운대구
                    </span>
                </div>

                <div th:if="${festival.master != null and festival.master.telNo != null}">
                    <span class="meta-label">문의</span>
                    <span class="meta-value" th:text="${festival.master.telNo}">051-000-0000</span>
                </div>

                <div th:if="${festival.master != null and festival.master.hmpgAddr != null}">
                    <span class="meta-label">홈페이지</span>
                    <a class="meta-link"
                       th:href="${festival.master.hmpgAddr}"
                       target="_blank"
                       th:text="${festival.master.hmpgAddr}">
                        홈페이지 바로가기
                    </a>
                </div>
            </div>

            <p class="hero-expected"
               th:if="${expectedPeriod != null}"
               th:text="|예상 방문 소요 시간: ${expectedPeriod}|">
                예상 방문 소요 시간: 반나절
            </p>
        </div>
    </section>

    <!-- ===== 축제 소개 섹션 ===== -->
    <section class="detail-section">
        <h2>축제 소개</h2>

        <p class="detail-overview"
           th:if="${festival.master != null and festival.master.overview != null}"
           th:text="${festival.master.overview}">
            축제에 대한 소개 문구가 들어갑니다.
        </p>

        <p class="detail-overview"
           th:if="${festival.master == null or festival.master.overview == null}">
            현재 제공되는 상세 소개 문구가 없습니다.
        </p>

        <!-- 축제 포스터 (크게 + 가운데 정렬) -->
        <div class="detail-poster-section"
             th:if="${festival.master != null and (festival.master.firstImageUrl2 != null or festival.master.originalImageUrl != null)}">
            <h3 class="poster-title">축제 포스터</h3>

            <div class="poster-image-wrapper">
                <img th:if="${festival.master.originalImageUrl != null}"
                     th:src="${festival.master.originalImageUrl}"
                     alt="축제 포스터 (고화질)"
                     class="poster-image"
                     onclick="window.open(this.src, '_blank')">

                <img th:if="${festival.master.originalImageUrl == null and festival.master.firstImageUrl2 != null}"
                     th:src="${festival.master.firstImageUrl2}"
                     alt="축제 포스터"
                     class="poster-image"
                     onclick="window.open(this.src, '_blank')">
            </div>
        </div>

        <!-- 추가 이미지 갤러리 -->
        <div class="detail-image-gallery"
             th:if="${festival.master != null and festival.master.imageUrls != null}">
            <h3 class="gallery-title">축제 사진</h3>
            <div class="gallery-grid" id="imageGallery"></div>
        </div>
    </section>

    <!-- ===== 기본 정보 테이블 ===== -->
    <section class="detail-section">
        <h2>기본 정보</h2>

        <table class="info-table">
            <tr>
                <th>개최 기간</th>
                <td th:text="${festival.fstvlStart != null and festival.fstvlEnd != null
                             ? (#temporals.format(festival.fstvlStart, 'yyyy.MM.dd') + ' ~ ' + #temporals.format(festival.fstvlEnd, 'yyyy.MM.dd'))
                             : ''}">
                    2025.12.11 ~ 2025.12.14
                </td>
            </tr>
            <tr>
                <th>개최 장소</th>
                <td th:text="${festival.master != null and festival.master.addr1 != null ? festival.master.addr1 : ''}">
                    부산 해운대구 벡스코 일원
                </td>
            </tr>
            <tr th:if="${festival.originNm != null}">
                <th>주최 / 주관</th>
                <td th:text="${festival.originNm}">주최/주관 정보</td>
            </tr>
        </table>
    </section>

    <!-- ===== 위치 정보 & 지도 ===== -->
    <section class="detail-section">
        <h2>위치 정보</h2>

        <p class="detail-address"
           th:text="${festival.master != null and festival.master.addr1 != null ? festival.master.addr1 : ''}">
            주소 텍스트
        </p>

        <div id="festivalDetailMap" class="detail-map"></div>
    </section>

    <!-- ===== 축제 리뷰 ===== -->
    <section class="detail-section review-section">
        <div class="section-header">
            <h2 class="section-title">축제 리뷰</h2>
        </div>

        <div th:if="${#lists.isEmpty(reviews)}" class="review-empty">
            아직 등록된 리뷰가 없습니다. 첫 리뷰를 남겨보세요!
        </div>

        <ul th:if="${!#lists.isEmpty(reviews)}" class="review-list">
            <li th:each="review : ${reviews}" class="review-item">
                <div class="review-header">
                    <div class="review-meta">
                        <span class="review-nickname" th:text="${review.nickname}">닉네임</span>
                        <span class="review-date"
                              th:text="${review.createdAt != null ? #temporals.format(review.createdAt, 'yyyy.MM.dd') : ''}">
                            2025.12.11
                        </span>
                    </div>
                    <div class="review-rating">
                        <span class="star">★</span>
                        <span th:text="${review.rating}">5</span>
                        <span class="rating-unit"> / 5</span>
                    </div>
                </div>

                <p class="review-content" th:text="${review.content}">리뷰 내용입니다.</p>

                <div class="review-footer">
                    <div class="review-actions"
                         th:if="${member != null and review.memberId != null and member.id.equals(review.memberId)}">
                        <button type="button"
                                class="btn-text edit-review-btn"
                                th:data-id="${review.id}"
                                th:data-content="${review.content}"
                                th:data-rating="${review.rating}">
                            수정
                        </button>
                        <button type="button"
                                class="btn-text delete-review-btn"
                                th:data-id="${review.id}">
                            삭제
                        </button>
                    </div>
                </div>
            </li>
        </ul>

        <div th:if="${member != null}" class="review-form-wrapper">
            <h3 class="review-form-title">리뷰 작성하기</h3>

            <form id="reviewForm" enctype="multipart/form-data" class="review-form">
                <div class="form-group">
                    <label class="form-label">
                        별점 <span class="required">*</span>
                    </label>
                    <div class="rating-input">
                        <span class="star-btn" data-rating="1">★</span>
                        <span class="star-btn" data-rating="2">★</span>
                        <span class="star-btn" data-rating="3">★</span>
                        <span class="star-btn" data-rating="4">★</span>
                        <span class="star-btn" data-rating="5">★</span>
                    </div>
                    <input type="hidden" id="ratingValue" value="5" required>
                </div>

                <div class="form-group">
                    <label for="reviewContent" class="form-label">
                        리뷰 내용 <span class="required">*</span>
                    </label>
                    <textarea
                            id="reviewContent"
                            rows="4"
                            placeholder="축제에 대한 솔직한 후기를 남겨주세요."
                            required
                            class="form-textarea"></textarea>
                </div>

                <div class="form-group">
                    <label for="reviewFile" class="form-label">사진 첨부 (선택)</label>
                    <input id="reviewFile" type="file" accept="image/*">
                </div>

                <div class="form-actions">
                    <button
                            type="button"
                            onclick="document.getElementById('reviewForm').reset(); updateStarRating(5);"
                            class="btn-cancel">
                        취소
                    </button>
                    <button type="submit" class="btn-submit">리뷰 등록</button>
                </div>
            </form>
        </div>

        <div class="review-login-hint" th:if="${member == null}">
            리뷰를 남기려면 먼저
            <a th:href="@{/auth/login}" class="link-inline">로그인</a>
            해주세요.
        </div>
    </section>

    <section class="detail-section">
        <a th:href="@{/festivals/list}" class="back-link">목록으로 돌아가기</a>
    </section>

</main>

<script type="text/javascript"
        src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=imrp8lidfv"></script>

<script th:inline="javascript">
/*<![CDATA[*/
    var lat = /*[[${festival.master != null ? festival.master.mapY : null}]]*/ null;
    var lng = /*[[${festival.master != null ? festival.master.mapX : null}]]*/ null;

    if (lat == null || lng == null) { lat = 35.1796; lng = 129.0756; }

    var map = new naver.maps.Map('festivalDetailMap', {
        center: new naver.maps.LatLng(lat, lng),
        zoom: 14
    });

    new naver.maps.Marker({
        position: new naver.maps.LatLng(lat, lng),
        map: map
    });

    const imageUrls = /*[[${festival.master != null ? festival.master.imageUrls : null}]]*/ null;

    if (imageUrls) {
        try {
            const images = JSON.parse(imageUrls);
            const gallery = document.getElementById('imageGallery');

            if (images && images.length > 0) {
                images.forEach(url => {
                    const img = document.createElement('img');
                    img.src = url;
                    img.alt = '축제 사진';
                    img.className = 'gallery-image';
                    img.onclick = function() { window.open(url, '_blank'); };
                    gallery.appendChild(img);
                });
            }
        } catch(e) {
            console.error('이미지 파싱 오류:', e);
        }
    }

    // ✅ 북마크 기능
    const bookmarkBtn = document.getElementById('bookmarkBtn');
    if (bookmarkBtn) {
        const eventId = bookmarkBtn.dataset.eventId;
        const bookmarkText = bookmarkBtn.querySelector('.bookmark-text');

        checkBookmarkStatus();

        async function checkBookmarkStatus() {
            try {
                const response = await fetch(`/api/bookmarks/event/${eventId}/check`);
                const data = await response.json();
                updateBookmarkButton(!!data.isBookmarked);
            } catch (err) {
                console.error('북마크 상태 확인 오류:', err);
            }
        }

        // ✅ textContent로 버튼을 통째로 덮어쓰지 말고(=SVG 사라짐 방지) span만 바꾸기
        function updateBookmarkButton(isBookmarked) {
            bookmarkBtn.classList.toggle('bookmarked', isBookmarked);
            bookmarkBtn.setAttribute('aria-pressed', String(isBookmarked));
            if (bookmarkText) bookmarkText.textContent = isBookmarked ? '북마크됨' : '북마크';
        }

        bookmarkBtn.addEventListener('click', async function() {
            const isBookmarked = this.classList.contains('bookmarked');

            try {
                const url = `/api/bookmarks/event/${eventId}`;
                const method = isBookmarked ? 'DELETE' : 'POST';

                const response = await fetch(url, { method });

                if (response.ok) {
                    updateBookmarkButton(!isBookmarked);

                    if (!isBookmarked) {
                        this.style.transform = 'scale(1.1)';
                        setTimeout(() => { this.style.transform = 'scale(1)'; }, 200);
                    }
                } else {
                    alert('북마크 처리에 실패했습니다.');
                }
            } catch (err) {
                console.error(err);
                alert('북마크 처리 중 오류가 발생했습니다.');
            }
        });
    }
/*]]>*/
</script>

<script th:inline="javascript">
/*<![CDATA[*/
    document.querySelectorAll('.star-btn').forEach(star => {
        star.addEventListener('click', function() {
            updateStarRating(parseInt(this.dataset.rating, 10));
        });
    });

    function updateStarRating(rating) {
        document.getElementById('ratingValue').value = rating;
        document.querySelectorAll('.star-btn').forEach((star, idx) => {
            star.style.color = (idx < rating) ? '#fbbf24' : '#d1d5db';
        });
    }
    updateStarRating(5);

    // 리뷰 등록
    document.getElementById('reviewForm')?.addEventListener('submit', async function(e) {
        e.preventDefault();

        const eventId = /*[[${festival.id}]]*/ 0;
        const rating = parseInt(document.getElementById('ratingValue').value, 10);
        const content = document.getElementById('reviewContent').value;
        const file = document.getElementById('reviewFile')?.files?.[0];

        if (!content.trim()) {
            alert('리뷰 내용을 입력해주세요.');
            return;
        }

        const formData = new FormData();
        const formJson = { rating, content };
        formData.append('form', new Blob([JSON.stringify(formJson)], { type: 'application/json' }));
        if (file) formData.append('file', file);

        try {
            const response = await fetch(`/api/reviews/event/${eventId}`, {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                alert('리뷰가 등록되었습니다.');
                location.reload();
            } else {
                alert('리뷰 등록 실패: ' + await response.text());
            }
        } catch (err) {
            console.error(err);
            alert('리뷰 등록 중 오류가 발생했습니다.');
        }
    });

    // 리뷰 수정/삭제 로직은 기존 그대로 두면 됨 (너 코드 그대로)
    // ...
/*]]>*/
</script>

</body>
</html>
