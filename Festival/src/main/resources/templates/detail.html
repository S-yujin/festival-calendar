<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${festival.fcltyNm}">축제 상세</title>
</head>
<body>
    <div th:replace="fragments/header :: header"></div>

    <h1 th:text="${festival.fcltyNm}">축제 이름</h1>

    <ul>
        <li>
            분류:
            <span th:text="${festival.lclasNm}"></span> /
            <span th:text="${festival.mlsfcNm}"></span>
        </li>
        <li>
            기간:
            <span th:text="${festival.fstvlBeginDe}"></span>
            ~
            <span th:text="${festival.fstvlEndDe}"></span>
        </li>
        <li>
            지역:
            <span th:text="${festival.ctprvnNm}"></span>
            <span th:text="${festival.signguNm}"></span>
        </li>
        <li>
            주소(법정동):
            <span th:text="${festival.legaldongNm}"></span>
        </li>
        <li>
            상세 주소(행정동):
            <span th:text="${festival.adstrdNm}"></span>
        </li>
        <li>
            위치:
            위도 <span th:text="${festival.fcltyLa}"></span>,
            경도 <span th:text="${festival.fcltyLo}"></span>
        </li>
        <li>
            전화번호:
            <span th:text="${festival.telNo}"></span>
        </li>
        <li>
            홈페이지:
            <a th:if="${festival.hmpgAddr != null}"
               th:href="${festival.hmpgAddr}"
               target="_blank"
               th:text="${festival.hmpgAddr}">홈페이지</a>
        </li>
    </ul>

    <h3>축제 소개</h3>
    <p th:text="${festival.fstvlCn}">내용</p>

    <!-- ================== 예상 개최 시기 블럭 ================== -->
    <div th:if="${expectedPeriod != null}">
        <h3>예상 개최 시기 ([[${expectedPeriod.targetYear}]]년)</h3>
        <p>
            이 축제는 보통
            <strong th:text="${expectedPeriod.month}">10</strong>월
            <strong th:text="${expectedPeriod.weekOfMonth}">4</strong>주차
            <strong th:text="${expectedPeriod.dayOfWeekKo}">토</strong>요일
            (<span th:text="${expectedPeriod.sampleCount}">0</span>년치 데이터 기준)
        </p>
    </div>

	<!-- ================== 후기 섹션 시작 ================== -->
	<section id="reviews" class="review-section">
	    <h2>축제 후기</h2>

	    <!-- ✅ 후기 리스트: 없을 때 -->
	    <div th:if="${#lists.isEmpty(reviews)}">
	        <p>등록된 후기가 아직 없습니다. 첫 후기를 남겨보세요!</p>
	    </div>

	    <!-- ✅ 후기 리스트: 있을 때 -->
	    <ul th:if="${!#lists.isEmpty(reviews)}" class="review-list">
	        <li th:each="review : ${reviews}" class="review-item">
	            <!-- 닉네임 -->
	            <span class="review-nickname" th:text="${review.nickname}">닉네임</span>

	            <!-- 작성일 -->
	            <span class="review-date"
	                  th:text="${review.createdAt != null ? #temporals.format(review.createdAt, 'yyyy-MM-dd') : ''}">
	                날짜
	            </span>

	            <!-- 내용 -->
	            <p class="review-content" th:text="${review.content}">내용</p>

	            <!-- 별점 -->
	            <span class="review-rating" th:text="${review.rating} + '점'">0점</span>

	            <!-- 첨부 이미지 다운로드 링크 -->
	            <span th:if="${review.attachmentId != null}">
	                <a th:href="@{/files/{id}(id=${review.attachmentId})}">
	                    첨부 이미지 다운로드
	                </a>
	            </span>

				<!-- ✅ 현재 로그인한 회원이 쓴 리뷰일 때만 수정/삭제 버튼 노출 -->
				<div th:if="${currentMemberId != null
							and review.member != null
				            and review.member.id == currentMemberId}">
						<button type="button"
				                class="edit-review-btn"
				                th:data-id="${review.id}"
				                th:data-content="${review.content}"
				                th:data-rating="${review.rating}">
				                수정
							</button>
				        <button type="button"
				                class="delete-review-btn"
				                th:data-id="${review.id}">
				                삭제
				            </button>
						</div>
					</li>
				</ul>

	    <hr/>
	    <!-- 후기 작성 폼 -->
	    <div th:if="${loggedIn}">
	        <h3>후기 작성하기</h3>
	        <form th:action="@{/festivals/{id}/reviews(id=${festival.id})}"
	              th:object="${reviewForm}"
	              method="post"
	              enctype="multipart/form-data">

	            <!-- 별점 -->
	            <label for="rating">별점</label>
	            <select id="rating" name="rating" th:field="*{rating}">
					<option value="1">★☆☆☆☆</option>
					<option value="2">★★☆☆☆</option>
					<option value="3">★★★☆☆</option>
					<option value="4">★★★★☆</option>
					<option value="5">★★★★★</option>
	            </select>

	            <!-- 내용 -->
	            <label for="content">내용</label>
	            <textarea id="content" name="content" th:field="*{content}" rows="4"></textarea>

	            <!-- 첨부 이미지 -->
	            <label for="imageFile">첨부 이미지 (선택)</label>
	            <input type="file" id="imageFile" name="imageFile" accept="image/*"/>

	            <!-- 검증 에러 메시지 -->
	            <div th:if="${#fields.hasErrors('*')}" class="validation-errors">
	                <p th:each="err : ${#fields.errors('*')}"
	                   th:text="${err}">에러 메시지</p>
	            </div>

	            <button type="submit">후기 등록</button>
	        </form>
	    </div>

	    <div th:if="${!loggedIn}">
	        <p>로그인 후 후기를 작성할 수 있습니다.</p>
	    </div>
	</section>

	<!-- ================== 후기 수정/삭제 스크립트 ================== -->
	<script th:inline="javascript">
	    // 리뷰 수정 버튼 클릭 핸들러
	    document.addEventListener("click", function (e) {
	        // 수정 버튼
	        if (e.target.classList.contains("edit-review-btn")) {
	            const btn = e.target;
	            const reviewId = btn.dataset.id;
	            const currentContent = btn.dataset.content;
	            const currentRating = btn.dataset.rating;

	            const newContent = prompt("수정할 후기를 입력하세요:", currentContent);
	            if (newContent === null) {
	                return; // 취소
	            }

	            const newRating = prompt("수정할 별점을 입력하세요 (1~5):", currentRating);
	            if (newRating === null) {
	                return;
	            }

	            fetch(`/api/reviews/${reviewId}`, {
	                method: "PATCH",
	                headers: {
	                    "Content-Type": "application/json"
	                },
	                body: JSON.stringify({
	                    content: newContent,
	                    rating: Number(newRating)
	                })
	            })
	                .then(res => {
	                    if (!res.ok) {
	                        throw new Error("리뷰 수정 실패");
	                    }
	                    return res.json();
	                })
	                .then(data => {
	                    // 화면 내용 갱신
	                    const li = btn.closest(".review-item");
	                    if (!li) return;

	                    const contentEl = li.querySelector(".review-content");
	                    const ratingEl = li.querySelector(".review-rating");

	                    if (contentEl) contentEl.textContent = data.content;
	                    if (ratingEl) ratingEl.textContent = data.rating + "점";

	                    // 버튼 data-*도 갱신
	                    btn.dataset.content = data.content;
	                    btn.dataset.rating = data.rating;

	                    alert("리뷰가 수정되었습니다.");
	                })
	                .catch(err => {
	                    console.error(err);
	                    alert("리뷰 수정 중 오류가 발생했습니다.");
	                });
	        }

	        // 삭제 버튼
	        if (e.target.classList.contains("delete-review-btn")) {
	            const btn = e.target;
	            const reviewId = btn.dataset.id;

	            if (!confirm("이 후기를 삭제하시겠습니까?")) {
	                return;
	            }

	            fetch(`/api/reviews/${reviewId}`, {
	                method: "DELETE"
	            })
	                .then(res => {
	                    if (!res.ok && res.status !== 204) {
	                        throw new Error("리뷰 삭제 실패");
	                    }
	                    // 화면에서 제거
	                    const li = btn.closest(".review-item");
	                    if (li) {
	                        li.remove();
	                    }
	                    alert("리뷰가 삭제되었습니다.");
	                })
	                .catch(err => {
	                    console.error(err);
	                    alert("리뷰 삭제 중 오류가 발생했습니다.");
	                });
	        }
	    });
	</script>
    <p>
        <a th:href="@{/festivals}">전체 목록으로</a>
        <a th:href="@{/festivals/calendar(year=${year}, month=${month})}">캘린더로</a>
    </p>
</body>
</html>
