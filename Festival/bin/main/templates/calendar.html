<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title th:text="|${year}년 ${month}월 축제 캘린더|">축제 캘린더</title>

    <!-- 공통/페이지 CSS -->
    <link rel="stylesheet" th:href="@{/css/base.css}">
    <link rel="stylesheet" th:href="@{/css/header.css}">
    <link rel="stylesheet" th:href="@{/css/calendar.css}">
</head>
<body>

<!-- 공통 헤더 -->
<div th:replace="~{fragments/header :: header}"></div>

<main class="calendar-layout">

    <!-- 상단 설명 + 월 이동 영역 -->
    <section class="calendar-top">
        <div class="calendar-title">
            <h1 th:text="|${year}년 ${month}월 축제 캘린더|">2025년 1월 축제 캘린더</h1>
            <p class="calendar-desc">
                한눈에 보는 월별 축제 일정입니다. 날짜별로 열리는 축제를 확인해 보세요.<br>
                아래 캘린더에서 날짜를 선택하면, 아래 리스트에서 해당 날짜의 축제를 볼 수 있습니다.
            </p>

            <p th:if="${year > 2025}" style="margin-top:8px; font-size:13px; color:#8a5a00;">
                ※ 2026년 이후 달력에는 ‘개최 예상’ 일정이 함께 표시될 수 있어요.
            </p>
        </div>

        <div class="calendar-controls">
            <!-- 이전/다음 달 이동 -->
            <div class="calendar-nav">
                <a class="cal-nav-btn"
                   th:href="@{/festivals/calendar(year=${prevYear}, month=${prevMonth})}">
                    ‹ 이전 달
                </a>
                <span class="cal-current" th:text="${year} + '.' + ${month}">2025.12</span>
                <a class="cal-nav-btn"
                   th:href="@{/festivals/calendar(year=${nextYear}, month=${nextMonth})}">
                    다음 달 ›
                </a>
            </div>

            <!-- 연/월 직접 선택 -->
            <form th:action="@{/festivals/calendar}" method="get" class="cal-form">
                <label>
                    연도
                    <input type="number" name="year" th:value="${year}" style="width:80px;">
                </label>
                <label>
                    월
                    <input type="number" name="month" min="1" max="12"
                           th:value="${month}" style="width:60px;">
                </label>
                <button type="submit">이동</button>
            </form>
        </div>
    </section>

    <!-- 캘린더 그리드 -->
    <section class="calendar-section">
        <table class="calendar-table">
            <thead>
            <tr>
                <th>일</th><th>월</th><th>화</th><th>수</th><th>목</th><th>금</th><th>토</th>
            </tr>
            </thead>

            <tbody class="calendar-body"
                   th:with="start=${calendarStart},
                            end=${calendarEnd},
                            lastDay=${end.dayOfMonth},
                            firstDow=${(#temporals.dayOfWeek(start) % 7) + 1}">

            <tr th:each="week : ${#numbers.sequence(0,5)}">
                <td th:each="dow : ${#numbers.sequence(1,7)}"
                    th:with="day=${week * 7 + dow - firstDow + 1},
                             valid=${day >= 1 and day <= lastDay}">

                    <div th:if="${valid}"
                         th:with="dayDate=${start.withDayOfMonth(day)},
                                  dayFestivals=${festivalMap[dayDate]}">

                        <a th:href="@{'/festivals/calendar'(year=${year}, month=${month}, day=${day})}"
                           th:class="${dayDate} == ${selectedDate} ? 'cal-cell day-link selected' : 'cal-cell day-link'">

                            <div class="cal-day-num" th:text="${day}">1</div>

                            <ul class="cal-day-festivals"
                                th:if="${dayFestivals != null}"
                                th:with="cnt=${#lists.size(dayFestivals)}">

                                <li th:each="f, st : ${dayFestivals}"
                                    th:if="${st.index} &lt; 2"
                                    th:with="
                                        isExpected=${#strings.startsWith(f.fcltyNm,'[예상]')},
                                        nm=${f.fcltyNm != null ? f.fcltyNm : ''},
                                        cn=${f.fstvlCn != null ? f.fstvlCn : ''},
                                        cat=${
                                          (#strings.contains(nm,'꽃') or #strings.contains(nm,'벚꽃') or #strings.contains(nm,'단풍') or #strings.contains(cn,'꽃')) ? 'flower' :
                                          (#strings.contains(nm,'먹') or #strings.contains(nm,'푸드') or #strings.contains(nm,'야시장') or #strings.contains(nm,'맥주') or #strings.contains(cn,'먹')) ? 'food' :
                                          (#strings.contains(nm,'음악') or #strings.contains(nm,'공연') or #strings.contains(nm,'콘서트') or #strings.contains(cn,'공연')) ? 'music' :
                                          (#strings.contains(nm,'문화') or #strings.contains(nm,'전통') or #strings.contains(nm,'체험') or #strings.contains(cn,'전통')) ? 'culture' :
                                          'etc'
                                        }">

                                    <!-- ✅ 카테고리 점 -->
                                    <span class="cal-dot" th:classappend="' dot-' + ${cat}"></span>

                                    <!-- ✅ 예상 배지 -->
                                    <span th:if="${isExpected}" class="cal-badge cal-badge-expected">예상</span>

                                    <!-- ✅ 표시용 이름 -->
                                    <span th:text="${#strings.replace(f.fcltyNm,'[예상] ','')}">축제명</span>
                                </li>

                                <li class="cal-more" th:if="${cnt > 2}">
                                    외 <span th:text="${cnt - 2}">0</span>개
                                </li>
                            </ul>
                        </a>
                    </div>
                </td>
            </tr>
            </tbody>
        </table>
    </section>

    <!-- 선택한 날짜의 축제 목록 -->
    <section class="month-list-section">
        <h2>이달의 축제 목록</h2>
        <p class="subtitle">날짜를 선택하면, 해당 날짜에 진행 중인 축제만 볼 수 있어요.</p>

        <div class="month-list-body">
            <!-- 왼쪽: 날짜 정보 -->
            <div class="day-info">
                <div class="day-text" th:text="${#temporals.format(selectedDate, 'MM.dd')}">12.11</div>
                <div class="day-dow" th:text="${#temporals.format(selectedDate, '(E)')}">(목)</div>
            </div>

            <!-- 오른쪽: 카드 리스트 -->
            <div class="month-card-wrapper">

                <div class="month-card-grid" th:if="${!#lists.isEmpty(dailyFestivals)}">
                    <article class="month-festival-card"
                             th:each="f : ${dailyFestivals}"
                             th:with="isExpected=${#strings.startsWith(f.fcltyNm,'[예상]')}">

                        <!-- ✅ 실제(id 있음) -->
                        <a th:if="${f.id != null}"
                           th:href="@{/festivals/{id}(id=${f.id})}">

                            <div th:if="${isExpected}" class="expected-badge">개최 예상</div>

                            <h3 class="month-festival-title"
                                th:text="${#strings.replace(f.fcltyNm,'[예상] ','')}">축제명</h3>

                            <p class="month-festival-meta">
                                <span class="period"
                                      th:text="${isExpected ? '개최 예상일: ' : ''} +
                                               ${#temporals.format(f.fstvlBeginDe,'MM.dd')} + ' ~ ' +
                                               ${#temporals.format(f.fstvlEndDe,'MM.dd')}">
                                    11.30 ~ 01.09
                                </span>
                                <span class="dot">·</span>
                                <span class="loc"
                                      th:text="${f.ctprvnNm + ' ' + f.signguNm}">
                                    경기 성남시
                                </span>
                            </p>
                        </a>

                        <!-- ✅ 예상(id 없음) → 패턴 상세로 이동 -->
                        <a th:if="${f.id == null}"
                           th:href="@{/festivals/expected(name=${#strings.replace(f.fcltyNm,'[예상] ','')}, year=${year})}"
                           class="month-card-no-link">

                            <div class="expected-badge">개최 예상</div>

                            <h3 class="month-festival-title"
                                th:text="${#strings.replace(f.fcltyNm,'[예상] ','')}">축제명</h3>

                            <p class="month-festival-meta">
                                <span class="period"
                                      th:text="${'개최 예상일: ' +
                                               #temporals.format(f.fstvlBeginDe,'MM.dd') + ' ~ ' +
                                               #temporals.format(f.fstvlEndDe,'MM.dd')}">
                                    11.30 ~ 01.09
                                </span>
                                <span class="dot">·</span>
                                <span class="loc"
                                      th:text="${f.ctprvnNm + ' ' + f.signguNm}">
                                    경기 성남시
                                </span>
                            </p>
                        </a>

                    </article>
                </div>

                <p class="no-festival-text" th:if="${#lists.isEmpty(dailyFestivals)}">
                    이 날에 진행 중인 축제가 없습니다.
                </p>
            </div>
        </div>
    </section>

    <div class="calendar-back-link">
        <a th:href="@{/festivals}">« 메인으로 돌아가기</a>
    </div>

</main>
</body>
</html>
