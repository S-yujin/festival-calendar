<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>축제 목록 - 축제 한눈에 보기</title>
    <link rel="stylesheet" th:href="@{/css/list.css}">
    <link rel="stylesheet" th:href="@{/css/header.css}">
</head>
<body>

<!-- 공통 헤더 -->
<div th:replace="~{fragments/header :: header}"></div>

<!-- 상단 필터 바 -->
<div class="filter-bar">
    <form th:action="@{/festivals/list}" method="get"
          style="display:flex; gap:8px; width:100%; align-items:center;">

        <!-- 숨겨진 필드: showAll 유지 -->
        <input type="hidden" name="showAll" th:value="${showAll}">

        <!-- 지역 -->
        <div>
            <label for="region" style="font-size:13px; color:#555;">지역</label>
            <select id="region" name="region" class="filter-btn">
                <option value="">전체</option>
                <option th:each="r : ${regions}"
                        th:value="${r}"
                        th:text="${r}"
                        th:selected="${r} == ${region}">
                </option>
            </select>
        </div>

        <!-- 기간 -->
        <div>
            <label for="startDate" style="font-size:13px; color:#555;">기간</label>
            <input type="date" id="startDate" name="startDate"
                   th:value="${startDate}" class="filter-btn">
            ~
            <input type="date" id="endDate" name="endDate"
                   th:value="${endDate}" class="filter-btn">
        </div>
		
        <!-- 혼잡도 -->
        <div>
            <label for="congestion" style="font-size:13px; color:#555;">혼잡도</label>
            <select id="congestion" name="congestion" class="filter-btn">
                <option value="">전체</option>
                <option value="여유" th:selected="${congestion}=='여유'">여유</option>
                <option value="보통" th:selected="${congestion}=='보통'">보통</option>
                <option value="혼잡" th:selected="${congestion}=='혼잡'">혼잡 예상</option>
            </select>
        </div>

        <!-- 키워드 -->
        <div style="flex:1;">
            <label for="keyword" style="font-size:13px; color:#555;">키워드</label>
            <input type="text" id="keyword" name="q"
                   th:value="${keyword}" class="filter-btn" style="width:100%;">
        </div>

        <!-- 검색/초기화 -->
        <div class="filter-right">
            <button type="submit" class="filter-btn"
                    style="background:#6c2bd9; color:#fff; border-color:#6c2bd9;">
                검색하기
            </button>
            <a th:href="@{/festivals/list}" class="sort-link">조건 초기화</a>
        </div>
    </form>
</div>

<!-- 2컬럼 레이아웃: 왼쪽 리스트, 오른쪽 지도 -->
<div class="page-2col">

    <!-- 왼쪽: 리스트 패널 -->
    <main class="list-panel">
        <section>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <div>
                    <h1 th:text="${showAll == 'true' ? year + '년 전국 축제 한눈에 보기' : '현재 진행 중인 축제'}">
                        현재 진행 중인 축제
                    </h1>
                    <p style="font-size:14px; color:#555; margin-top:4px;">
                        <span th:if="${showAll != 'true'}">지금 열리고 있는 축제를 확인하세요.</span>
                        <span th:if="${showAll == 'true'}">지역·날짜·유형·혼잡도 조건을 선택해서 원하는 축제를 빠르게 찾아보세요.</span>
                    </p>
                </div>

                <!-- 전체/진행중 토글 버튼 -->
				<div class="view-toggle">
				  <a class="toggle-btn"
				     th:classappend="${showAll != 'true' ? ' active' : ''}"
				     th:href="@{/festivals/list(region=${region}, startDate=${startDate}, endDate=${endDate},
				               congestion=${congestion}, q=${keyword}, showAll='false')}">
				    진행 중만
				  </a>

				  <a class="toggle-btn"
				     th:classappend="${showAll == 'true' ? ' active' : ''}"
				     th:href="@{/festivals/list(region=${region}, startDate=${startDate}, endDate=${endDate},
				               congestion=${congestion}, q=${keyword}, showAll='true')}">
				    전체 보기
				  </a>
				</div>
            </div>
        </section>

        <!-- 결과 없을 때 -->
        <p th:if="${#lists.isEmpty(festivals)}" style="margin-top:16px;">
            조건에 맞는 축제가 없습니다.
        </p>

        <!-- 카드 리스트 -->
        <section th:if="${!#lists.isEmpty(festivals)}" style="margin-top:16px;">
            <div class="card-list">
                <article class="festival-card" th:each="f : ${festivals}">
                    <a th:href="@{/festivals/{id}(id=${f.id})}">

                        <!-- 인네일 -->
                        <div class="card-thumb">
							<img th:src="${(f.master != null and f.master.firstImageUrl != null)
							              ? f.master.firstImageUrl
							              : @{/img/placeholder.svg}}"
							     alt="축제 이미지">
                        </div>

                        <!-- 텍스트 영역 -->
                        <div class="card-body">
                            <span class="status-badge"
                                  th:with="status=${T(com.springboot.domain.FestivalStatus).valueOf(
                                            f.fstvlStart != null and f.fstvlEnd != null and
                                            !today.isBefore(f.fstvlStart) and !today.isAfter(f.fstvlEnd) ? 'ONGOING' :
                                            (today.isBefore(f.fstvlStart) ? 'UPCOMING' : 'PAST')
                                        )}"
                                  th:classappend="${status.name() == 'ONGOING' ? 'badge-ongoing' : 
                                                   (status.name() == 'UPCOMING' ? 'badge-upcoming' : 'badge-past')}"
                                  th:text="${status.name() == 'ONGOING' ? '진행 중' : 
                                           (status.name() == 'UPCOMING' ? '예정' : '종료')}">
                                축제
                            </span>

                            <h3 class="card-title" th:text="${f.fcltyNm}">축제명</h3>

                            <p class="card-period"
                               th:text="${#temporals.format(f.fstvlStart, 'MM.dd')} + ' ~ ' +
                                        ${#temporals.format(f.fstvlEnd, 'MM.dd')}">
                                00.00 ~ 00.00
                            </p>

							<p class="card-loc"
							   th:if="${f.master != null and f.master.ctprvnNm != null and f.master.signguNm != null 
							           and !f.master.ctprvnNm.isBlank() and !f.master.signguNm.isBlank()}"
							   th:text="${f.master.ctprvnNm + ' ' + f.master.signguNm}">
							</p>
                        </div>
                    </a>
                </article>
            </div>
        </section>
    </main>

    <!-- 오른쪽: 지도 패널 -->
    <aside class="map-panel">
        <div class="map-toolbar">
            <span style="font-size: 14px; font-weight: 600; color: #333;">지도에서 보기</span>
        </div>

        <p th:if="${#lists.isEmpty(markers)}" class="map-empty">
            현재 지도에 표시할 축제가 없습니다.
        </p>

        <div id="festivalMap"></div>
    </aside>

</div>

<!-- 네이버 지도 API -->
<script type="text/javascript"
        src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=imrp8lidfv"></script>

<!-- 네이버 지도 위에 마커 그리기 -->
<script th:inline="javascript">
/*<![CDATA[*/
  var markers = /*[[${markers}]]*/ [];

  var map = new naver.maps.Map('festivalMap', {
    center: new naver.maps.LatLng(36.5, 127.5),
    zoom: 7
  });

  // 지도 div 크기 잡힌 뒤 리사이즈 한번
  setTimeout(function () {
    naver.maps.Event.trigger(map, 'resize');
  }, 0);

  if (markers.length > 0) {
    var bounds = new naver.maps.LatLngBounds();
    var validCount = 0;

    markers.forEach(function (m) {
      var lat = Number(m.lat);
      var lng = Number(m.lng);

      // null/NaN/0,0 제거
      if (!isFinite(lat) || !isFinite(lng)) return;
      if (lat === 0 || lng === 0) return;

      // 대충 한국 영역만(이상치 제거)
      if (lat < 33 || lat > 39.5 || lng < 124 || lng > 132) return;

      validCount++;

      var position = new naver.maps.LatLng(lat, lng);
      var status = (m.status || "PAST");

      var marker = new naver.maps.Marker({
        position: position,
        map: map,
        icon: {
          content: '<div class="nm-marker ' + status + '"></div>',
          anchor: new naver.maps.Point(7, 7)
        },
        zIndex: (status === "ONGOING" ? 200 : status === "UPCOMING" ? 150 : 100)
      });

      var info = new naver.maps.InfoWindow({
        content:
          '<div style="padding:6px 10px; font-size:12px;">' +
            '<a href="/festivals/' + m.id + '" style="text-decoration:none;">' +
              m.name +
            '</a>' +
          '</div>'
      });

      naver.maps.Event.addListener(marker, 'click', function () {
        info.open(map, marker);
      });

      bounds.extend(position);
    });

    // 유효한 마커가 있을 때만 fitBounds
    if (validCount > 0) {
      // padding 주면 오른쪽 패널에서도 보기 좋음
      map.fitBounds(bounds, { top: 40, right: 40, bottom: 40, left: 40 });

      // 너무 확대/축소 되는 거 방지(원하면 조절)
      if (map.getZoom() > 12) map.setZoom(12);
      if (map.getZoom() < 6) map.setZoom(6);
    }
  }
/*]]>*/
</script>
</body>
</html>